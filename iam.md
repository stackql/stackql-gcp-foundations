# IAM Guide

> [StackQL](https://github.com/stackql/stackql) used to master and maintain IAM bindings for the Terraform service accounts and priveleged access groups (defined in Cloud Identity for instance)  

IAM bindings are created at the following levels:  

- organisation level
- folder level
- project level (typically for root level projects like `audit`
- storage bucket level (for Terraform state files, etc)
- billing account level

## How it works

The following directory tree shows the files used in provisioning IAM bindings of policy documents to principals in the GCP Org.  

```
├── iql
│   ├── iam.iql
│   ├── ...
├── data
│   ├── iam.jsonnet
│   ├── iam
│   │   ├── bindings.json
│   │   ├── custom_roles.json
```

## `iql/iam.iql`

This is the main file which will be run by the `stackql`, using the `data/iam.jsonnet` this will render and apply the transpiled policy bindings generated from the data in `data/iam/bindings.json`

> this file should not need to be modified

## `data/iam.jsonnet`

This file is preprocessed by `iql/iam.iql` sourcing data from `data/iam/bindings.json`

> this file should not need to be modified

## `data/iam/bindings.json`

> this file __will need to be modified__ to make policy binding changes

This is the master source of policy and binding data, the data structure maps one or many principals (groups, serviceaccount, etc) to one or many roles (predefined or custom) at a particular level (parent) as shown below:

```json
  "<< level >>": [
    {
      "members": [
        "<< principal >>",
        ...
      ],
      "roles": [
        "<< role >>",
        ...
      ]
    },
```

for example:

```json
  "folders": {
    "nonprod": [
      {
        "members": [
          "serviceAccount:terraform-nonprod@stackql-foundations-terraform.iam.gserviceaccount.com"
        ],
        "roles": [
          "roles/compute.networkAdmin",
          "roles/resourcemanager.folderViewer",
          "roles/resourcemanager.projectCreator",
          "roles/storage.admin",
          "roles/artifactregistry.admin",
          "roles/container.serviceAgent",
          "roles/iam.securityAdmin",
          "roles/bigquery.admin",
          "roles/serviceusage.serviceUsageAdmin",
          "roles/cloudsql.admin",
          "roles/iam.serviceAccountAdmin",
          "roles/pubsub.admin",
          "roles/cloudfunctions.developer"
        ]
      }
    ],
```

# Deployment

This process could be run through a CI/CD pipeline, however as the changes at this level are infrequent (applying the axiom of **"users to groups, groups to roles, roles to permissions")**, and you may not wish to give a service account the levels of priveleges required to deploy this.  In either case it needs to be run by a priveleged member (user or service account).  

If you are running this interactively, the user needs to be authenticated to GCP, using `gcloud auth login` prior to running this script  

Run the following command to perform a dryrun:
```
stackql exec -i ./iql/iam.iql \
--iqldata ./data/iam.jsonnet \
--outfile iam-TEMPLATED.iql \
--dryrun --output text --hideheaders
```

The resultant data in this file can be exectuted as individual statements in `stackql shell` or as a batch by running:  

```
stackql exec -i iam-TEMPLATED.iql \
```
Alternatively, you could take the policies (JSON payloads) generated by this script and run them using the `gcloud iam` command.  
